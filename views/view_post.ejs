<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <!-- CSS Styles Hiearchy -->
    <link rel="stylesheet" href="/theme.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/partials.css">
    <link rel="stylesheet" href="/view_post.css">
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title><%= title %></title>
</head>
<body>
    <!-- header.ejs -->
    <%- include("partials/header.ejs") %>

    <!-- main -->
    <main>
        <!-- sidebar.ejs -->
        <%- include("partials/sidebar.ejs") %>
        
        <!-- content -->
        <section class="main-content">
            <!-- post container -->
            <div class="main-container">
                <div class="post-card">
                    <!-- Post Image -->
                     <header class="post-content">
                         <img src="<%- post.imageURL %>" alt="Post image" class="post-image">
                     </header>
                    
                    <!-- Post Header -->
                    <header class="post-header">
                        <div class="post-author">
                            <div class="author-avatar">
                                <%= accountName.charAt(0).toUpperCase() %>
                            </div>
                            <div class="author-info">
                                <a href="/user/<%= post.accountID %>" class="author-name"><%= accountName %></a>
                                <p class="post-timestamp"><%= formattedTimestamp %></p>
                            </div>
                        </div>
                        
                        <div class="post-actions">
                            <% if (post.accountID == id) { %>
                                <a href="/post/<%= postID %>/edit" class="btn btn-outline">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <button onclick="deletePost('<%= postID %>');" id="delete-post" class="delete-button">
                                    <i class="fas fa-trash delete-button"></i> Delete
                                </button>
                            <% } %>
                        </div>
                    </header>
                    <!-- post caption -->
                    <div class="post-caption"><%= post.caption %></div>
                </div>

                <!-- divider -->
                <div class="divider"></div>
                
                <!-- comment containers -->
                <section class="comment-card">
                     <% if (isAuthenticated) { %>
                        <!-- comment prompt -->
                         <div class="comment-form">
                             <form action="/post/<%= postID %>" method="POST" id="commentForm">
                                 <textarea 
                                     name="comment" 
                                     class="comment-textarea" 
                                     placeholder="Add a comment as <%= firstName %> <%= lastName %>..." 
                                     required
                                 ></textarea>
                                 <button type="submit" class="btn btn-primary">
                                     <i class="fas fa-paper-plane"></i> Post Comment
                                 </button>
                             </form>
                         </div>
                     <% } else { %>
                        <!-- w/o authorization -->
                         <div class="auth-prompt">
                             <p><a href="/login?redirectURL=/post/<%= postID %>">Log in</a> or <a href="/signup?redirectURL=/post/<%= postID %>">Sign up</a> to comment on this post.</p>
                         </div>
                     <% } %>
                     
                     <!-- comment section -->
                     <div class="comments-section">
                         <div class="comments-header">
                             <h3 class="comments-count">
                                 <% if (comments && comments.length > 0) { %>
                                     <%= comments.length %> <%= comments.length === 1 ? 'Comment' : 'Comments' %>
                                 <% } else { %>
                                     Comments
                                 <% } %>
                             </h3>
                         </div>
                         
                         <% if (comments && comments.length > 0) { %>
                             <div class="comments-list">
                                 <% comments.forEach(comment => { %>
                                     <div class="comment-card">
                                         <div class="comment-header">
                                             <div class="comment-author">
                                                 <div class="emoji-avatar">
                                                     <%= comment.accountName.charAt(0).toUpperCase() %>
                                                 </div>
                                                 <a href="/user/<%= comment.accountID %>" class="comment-author-name">
                                                     <%= comment.accountName %>
                                                 </a>
                                             </div>
                                             <span class="comment-timestamp"><%= comment.formattedTimestamp %></span>
                                         </div>
                                         <div class="comment-content"><%= comment.content %></div>
                                     </div>
                                 <% }) %>
                             </div>
                         <% } else { %>
                            <!-- empty comments -->
                             <div class="no-comments">
                                 <p>No comments yet. Be the first to share your thoughts!</p>
                             </div>
                         <% } %>
                     </div>
                 </section>
            </div>
        </section>
    </main>
    <%- include("partials/bottom_navigation.ejs") %>

    <script>
        // Crunch button interaction
        const crunchButton = document.getElementById('crunchButton');
        if (crunchButton) {
            crunchButton.addEventListener('click', function() {
                // Toggle active state
                this.classList.toggle('btn-primary');
                this.classList.toggle('btn-outline');
                
                // You would typically send an AJAX request to your server here
                // to record the crunch action
                
                // Visual feedback
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-star');
                icon.classList.toggle('fa-star-half');
            });
        }
        
        // Comment form character counter could be added here
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            const textarea = commentForm.querySelector('textarea');
            
            // Optional: Add dynamic textarea height
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }
        
        // Image error handling
        const postImage = document.querySelector('.post-image');
        if (postImage) {
            postImage.onerror = function() {
                this.src = '/images/placeholder.jpg'; // Replace with your placeholder image path
                this.alt = 'Image not available';
            };
        }

        // Function to make URLs in text clickable
        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function(url) {
                return '<a href="' + url + '" target="_blank">' + url + '</a>';
            });
        }

        // Apply linkify to post caption
        const postContentElement = document.querySelector('.post-caption');
        if (postContentElement) {
            postContentElement.innerHTML = linkify(postContentElement.innerHTML);
        }

        // Delete post
        function deletePost(postID) {
            if (confirm("Are you sure you want to delete this post?")) {
                fetch(`/post/${postID}/delete`, {
                    method: "DELETE"
                })
                .then(response => {
                    if (response.ok) {
                        alert("Post deleted successfully");
                        window.location.href = '/';
                    } else {
                        alert("Error deleting post.");
                    }
                });
            }
        }
    </script>
</body>
</html>